use fuzzy_matcher::skim::SkimMatcherV2;
use fuzzy_matcher::FuzzyMatcher;
use serde::{Deserialize, Serialize};
use serde_json;
use wasm_bindgen::prelude::*;
use wasm_bindgen_test::*;
use web_sys;

#[allow(dead_code)]
#[derive(Serialize, Deserialize, Debug, Clone)]
#[wasm_bindgen(getter_with_clone)]
pub struct Location {
    pub name: String,
    pub address: String,
    pub zip: i32,
    pub phone: String,
    pub latitude: f64,
    pub longitude: f64,
    pub everything_name: String,
}

#[wasm_bindgen]
#[allow(non_snake_case)]
impl Location {
    pub fn toJSON(&self) -> String {
        serde_json::to_string(self).unwrap()
    }
}

#[wasm_bindgen]
pub fn get_best_match(name: String) -> Location {
    let people = vec![
        Location {
            name: "Allapattah".to_string(),
            address: "1799 NW 35 St. Miami, FL".to_string(),
            zip: 33142,
            phone: "305-638-6086".to_string(),
            latitude: 25.8087898,
            longitude: -80.2256335,
            everything_name: "Allapattah Branch Library".to_string(),
        },
        Location {
            name: "Arcola Lakes".to_string(),
            address: "8240 NW 7 Ave. Miami, FL".to_string(),
            zip: 33150,
            phone: "305-694-2707".to_string(),
            latitude: 25.8502313,
            longitude: -80.2099399,
            everything_name: "Arcola Lakes Branch Library".to_string(),
        },
        Location {
            name: "Bay Harbor Islands".to_string(),
            address: "1175 95 St. Bay Harbor Islands, FL".to_string(),
            zip: 33154,
            phone: "786-582-2620".to_string(),
            latitude: 25.886,
            longitude: -80.13232,
            everything_name: "Bay Harbor Islands Branch Library".to_string(),
        },
        Location {
            name: "California Club".to_string(),
            address: "700 Ives Dairy Rd. Miami, FL".to_string(),
            zip: 33179,
            phone: "305-770-3161".to_string(),
            latitude: 25.9601721,
            longitude: -80.1883811,
            everything_name: "California Club Branch Library".to_string(),
        },
        Location {
            name: "Civic Center".to_string(),
            address: "1501 NW 12 Ave. Miami, FL 33136 Metrorail Civic Center".to_string(),
            zip: 33136,
            phone: "305-324-0291".to_string(),
            latitude: 25.9882385,
            longitude: -80.3006957,
            everything_name: "Miramar Branch Library & Education Center".to_string(),
        },
        Location {
            name: "Coconut Grove".to_string(),
            address: "2875 McFarlane Rd. Miami, FL".to_string(),
            zip: 33133,
            phone: "305-442-8695".to_string(),
            latitude: 25.7267780257582,
            longitude: -80.2403374291725,
            everything_name: "Coconut Grove Branch Library".to_string(),
        },
        Location {
            name: "Concord".to_string(),
            address: "3882 SW 112 Ave. Miami, FL".to_string(),
            zip: 33165,
            phone: "305-207-1344".to_string(),
            latitude: 25.7333452,
            longitude: -80.3761289,
            everything_name: "Miami‑Dade Public Library - Concord Branch Library".to_string(),
        },
        Location {
            name: "Coral Gables".to_string(),
            address: "3443 Segovia St. Coral Gables, FL".to_string(),
            zip: 33134,
            phone: "305-442-8706".to_string(),
            latitude: 25.7396484,
            longitude: -80.2658856,
            everything_name: "Miami‑Dade Public Library".to_string(),
        },
        Location {
            name: "Coral Gables(Temporary Location)".to_string(),
            address: "308 Miracle Mile Coral Gables, FL".to_string(),
            zip: 33134,
            phone: "305-442-8706".to_string(),
            latitude: 25.749130,
            longitude: -80.260970,
            everything_name: "None".to_string(),
        },
        Location {
            name: "Coral Reef".to_string(),
            address: "9211 SW 152 St. Miami, FL".to_string(),
            zip: 33157,
            phone: "305-233-8324".to_string(),
            latitude: 25.6293297,
            longitude: -80.3429294,
            everything_name: "Coral Reef Branch Library".to_string(),
        },
        Location {
            name: "Country Walk".to_string(),
            address: "15433 SW 137 Ave. Miami, FL".to_string(),
            zip: 33177,
            phone: "786-293-4577".to_string(),
            latitude: 25.623976,
            longitude: -80.413231,
            everything_name: "Miami-Dade Public Library System - Country Walk Branch".to_string(),
        },
        Location {
            name: "Culmer Overtown".to_string(),
            address: "350 NW 13 St. Miami, FL".to_string(),
            zip: 33136,
            phone: "305-579-5322".to_string(),
            latitude: 25.786609,
            longitude: -80.200667,
            everything_name: "Culmer Overtown Branch Library".to_string(),
        },
        Location {
            name: "Doral".to_string(),
            address: "8551 NW 53 St. #A107 Doral, FL".to_string(),
            zip: 33166,
            phone: "305-716-9598".to_string(),
            latitude: 25.8200502,
            longitude: -80.3367537,
            everything_name: "Miami‑Dade Public Library System".to_string(),
        },
        Location {
            name: "Edison Center".to_string(),
            address: "531 NW 62 St. Miami, FL".to_string(),
            zip: 33150,
            phone: "305-757-0668".to_string(),
            latitude: 25.8325899,
            longitude: -80.2052111,
            everything_name: "Edison Center Branch Library".to_string(),
        },
        Location {
            name: "Fairlawn".to_string(),
            address: "6376 SW 8 St. West Miami, FL".to_string(),
            zip: 33144,
            phone: "305-261-1571".to_string(),
            latitude: 25.7628583,
            longitude: -80.2994316,
            everything_name: "Fairlawn Branch Library".to_string(),
        },
        Location {
            name: "Golden Glades".to_string(),
            address: "100 NE 166 St. Miami, FL".to_string(),
            zip: 33162,
            phone: "305-787-1544".to_string(),
            latitude: 25.9269302,
            longitude: -80.1972073,
            everything_name: "Golden Glades Branch Library".to_string(),
        },
        Location {
            name: "Hialeah Gardens".to_string(),
            address: "13451 NW 107 Ave. Hialeah Gardens, FL".to_string(),
            zip: 33018,
            phone: "305-820-8520".to_string(),
            latitude: 25.895989,
            longitude: -80.372033,
            everything_name: "Miami‑Dade Public Library".to_string(),
        },
        Location {
            name: "Hispanic".to_string(),
            address: "1398 SW 1 St. Miami, FL".to_string(),
            zip: 33135,
            phone: "305-643-8574".to_string(),
            latitude: 25.7721725,
            longitude: -80.2175051,
            everything_name: "Miami-Dade Public Library System - Hispanic Branch Library"
                .to_string(),
        },
        Location {
            name: "International Mall".to_string(),
            address: "10315 NW 12 St. Doral, FL".to_string(),
            zip: 33172,
            phone: "305-594-2514".to_string(),
            latitude: 25.7842201,
            longitude: -80.3626435,
            everything_name: "International Mall Branch Library".to_string(),
        },
        Location {
            name: "Kendale Lakes".to_string(),
            address: "15205 SW 88 St. Miami, FL".to_string(),
            zip: 33196,
            phone: "305-388-0326".to_string(),
            latitude: 25.6851823,
            longitude: -80.4416308,
            everything_name: "Kendale Lakes Branch Library".to_string(),
        },
        Location {
            name: "Kendall".to_string(),
            address: "9101 SW 97 Ave. Miami, FL".to_string(),
            zip: 33176,
            phone: "305-279-0520".to_string(),
            latitude: 25.6855501,
            longitude: -80.3505279,
            everything_name: "Kendall Branch Library".to_string(),
        },
        Location {
            name: "Key Biscayne".to_string(),
            address: "299 Crandon Blvd. Key Biscayne, FL".to_string(),
            zip: 33149,
            phone: "305-361-6134".to_string(),
            latitude: 25.696287,
            longitude: -80.162636,
            everything_name: "Key Biscayne Branch Library".to_string(),
        },
        Location {
            name: "Lakes of the Meadow".to_string(),
            address: "4284 SW 152 Ave. Miami, FL".to_string(),
            zip: 33185,
            phone: "305-222-2149".to_string(),
            latitude: 25.7265393196268,
            longitude: -80.4402637481689,
            everything_name: "Lakes of The Meadow Branch Library".to_string(),
        },
        Location {
            name: "Lemon City".to_string(),
            address: "430 NE 61 St. Miami, FL".to_string(),
            zip: 33137,
            phone: "305-757-0662".to_string(),
            latitude: 25.8323730096071,
            longitude: -80.1870329,
            everything_name: "Lemon City Branch".to_string(),
        },
        Location {
            name: "Little River".to_string(),
            address: "160 NE 79 St. Miami, FL".to_string(),
            zip: 33138,
            phone: "305-751-8689".to_string(),
            latitude: 25.8473122,
            longitude: -80.1936722,
            everything_name: "Little River Branch Library".to_string(),
        },
        Location {
            name: "Main Library".to_string(),
            address: "101 W Flagler St. Miami, FL".to_string(),
            zip: 33130,
            phone: "305-375-2665".to_string(),
            latitude: 26.1207688469696,
            longitude: -80.143096446991,
            everything_name: "Broward County Main Library".to_string(),
        },
        Location {
            name: "Miami Beach Regional".to_string(),
            address: "227 22nd St. Miami Beach, FL".to_string(),
            zip: 33139,
            phone: "305-535-4219".to_string(),
            latitude: 25.7980445,
            longitude: -80.1289809,
            everything_name: "Miami Beach Regional Library".to_string(),
        },
        Location {
            name: "Miami Lakes".to_string(),
            address: "6699 Windmill Gate Rd. Miami Lakes, FL".to_string(),
            zip: 33014,
            phone: "305-822-6520".to_string(),
            latitude: 25.9235286,
            longitude: -80.3088884,
            everything_name: "Miami‑Dade Public Library".to_string(),
        },
        Location {
            name: "Miami Springs".to_string(),
            address: "401 Westward Dr. Miami Springs, FL".to_string(),
            zip: 33166,
            phone: "305-805-3811".to_string(),
            latitude: 25.8214756,
            longitude: -80.2876709,
            everything_name: "Miami Springs Branch Library".to_string(),
        },
        Location {
            name: "Model City".to_string(),
            address: "2211 NW 54 St. Miami, FL".to_string(),
            zip: 33142,
            phone: "305-636-2233".to_string(),
            latitude: 25.8245194,
            longitude: -80.23356,
            everything_name: "Model City Branch Library".to_string(),
        },
        Location {
            name: "Naranja".to_string(),
            address: "14850 SW 280 St. Miami, FL".to_string(),
            zip: 33032,
            phone: "305-242-2290".to_string(),
            latitude: 25.5062172880611,
            longitude: -80.43073117733,
            everything_name: "Miami-Dade Public Library System - Naranja Branch".to_string(),
        },
        Location {
            name: "North Central".to_string(),
            address: "9590 NW 27 Ave. Miami, FL".to_string(),
            zip: 33147,
            phone: "305-693-4541".to_string(),
            latitude: 25.8617543,
            longitude: -80.2428548,
            everything_name: "North Central Branch Library".to_string(),
        },
        Location {
            name: "North Dade Regional".to_string(),
            address: "2455 NW 183 St. Miami Gardens, FL".to_string(),
            zip: 33056,
            phone: "305-625-6424".to_string(),
            latitude: 26.2701128,
            longitude: -80.2484428,
            everything_name: "Northwest Regional Library".to_string(),
        },
        Location {
            name: "North Shore".to_string(),
            address: "7501 Collins Ave. Miami Beach, FL".to_string(),
            zip: 33141,
            phone: "305-864-5392".to_string(),
            latitude: 25.8609215,
            longitude: -80.1207834,
            everything_name: "Miami-Dade Public Library System - North Shore Branch".to_string(),
        },
        Location {
            name: "Northeast Dade – Aventura".to_string(),
            address: "2930 Aventura Blvd. Aventura, FL ".to_string(),
            zip: 33180,
            phone: "305-931-5512".to_string(),
            latitude: 25.9604619035148,
            longitude: -80.1426603,
            everything_name: "Northeast Dade - Aventura Branch Library".to_string(),
        },
        Location {
            name: "Opa-Locka".to_string(),
            address: "780 Fisherman St., Suite 140 Opa-locka, FL".to_string(),
            zip: 33054,
            phone: "305-688-1134".to_string(),
            latitude: 25.9019874,
            longitude: -80.2514142,
            everything_name: "Opa-locka Branch Library".to_string(),
        },
        Location {
            name: "Palm Springs North".to_string(),
            address: "17601 NW 78 Ave., Suite 111 Hialeah, FL".to_string(),
            zip: 33015,
            phone: "305-820-8564".to_string(),
            latitude: 26.6408234,
            longitude: -80.0960017,
            everything_name: "Palm Springs Library".to_string(),
        },
        Location {
            name: "Palmetto Bay".to_string(),
            address: "17641 Old Cutler Rd. Palmetto Bay, FL".to_string(),
            zip: 33157,
            phone: "305-232-1771".to_string(),
            latitude: 25.6069531,
            longitude: -80.3111168,
            everything_name: "Palmetto Bay Branch Library".to_string(),
        },
        Location {
            name: "Pinecrest".to_string(),
            address: "5835 SW 111 St. Pinecrest, FL".to_string(),
            zip: 33156,
            phone: "305-668-4571".to_string(),
            latitude: 25.6686527,
            longitude: -80.2868229,
            everything_name: "Pinecrest Branch Library".to_string(),
        },
        Location {
            name: "Shenandoah".to_string(),
            address: "2111 SW 19 St. Miami, FL".to_string(),
            zip: 33145,
            phone: "305-250-4688".to_string(),
            latitude: 25.7547343457951,
            longitude: -80.2286166165579,
            everything_name: "Shenandoah Branch Library".to_string(),
        },
        Location {
            name: "South Dade Regional".to_string(),
            address: "10750 SW 211 St. Cutler Bay, FL".to_string(),
            zip: 33189,
            phone: "305-233-8140".to_string(),
            latitude: 25.9417132,
            longitude: -80.2423821,
            everything_name: "North Dade Regional Library".to_string(),
        },
        Location {
            name: "South Miami".to_string(),
            address: "6000 Sunset Dr. South Miami, FL".to_string(),
            zip: 33143,
            phone: "305-667-6121".to_string(),
            latitude: 25.7704061,
            longitude: -80.1377641,
            everything_name: "South Shore Branch Library".to_string(),
        },
        Location {
            name: "South Shore".to_string(),
            address: "131 Alton Rd. Miami Beach, FL".to_string(),
            zip: 33139,
            phone: "305-535-4223".to_string(),
            latitude: 25.7704061,
            longitude: -80.1377641,
            everything_name: "South Shore Branch Library".to_string(),
        },
        Location {
            name: "Sunny Isles Beach".to_string(),
            address: "18070 Collins Ave. Sunny Isles Beach, FL".to_string(),
            zip: 33160,
            phone: "305-682-0726".to_string(),
            latitude: 25.9091173368813,
            longitude: -80.1211559772491,
            everything_name: "Haulover Beach Park".to_string(),
        },
        Location {
            name: "Sunset".to_string(),
            address: "10855 SW 72 St. #13-14 Miami, FL".to_string(),
            zip: 33173,
            phone: "305-270-6368".to_string(),
            latitude: 25.7027063,
            longitude: -80.3693555,
            everything_name: "Miami‑Dade Public Library".to_string(),
        },
        Location {
            name: "Tamiami".to_string(),
            address: "12700 SW 8 St. Miami, FL".to_string(),
            zip: 33184,
            phone: "305-223-4758".to_string(),
            latitude: 26.6880476,
            longitude: -81.8865564,
            everything_name: "North Fort Myers Public Library".to_string(),
        },
        Location {
            name: "Virrick Park".to_string(),
            address: "3255 Plaza St. Miami, FL".to_string(),
            zip: 33133,
            phone: "305-442-7872".to_string(),
            latitude: 27.7638931971226,
            longitude: -82.6396322250366,
            everything_name: "The Library".to_string(),
        },
        Location {
            name: "West Flagler".to_string(),
            address: "5050 W Flagler St. Miami, FL".to_string(),
            zip: 33134,
            phone: "305-442-8710".to_string(),
            latitude: 25.7709481433915,
            longitude: -80.2773463726044,
            everything_name: "Miami‑Dade Public Library".to_string(),
        },
        Location {
            name: "West Kendall Regional".to_string(),
            address: "10201 Hammocks Blvd. Miami, FL".to_string(),
            zip: 33196,
            phone: "305-385-7135".to_string(),
            latitude: 30.4154589418632,
            longitude: -87.2191500663757,
            everything_name: "West Florida Public Libraries- WFPL".to_string(),
        },
        Location {
            name: "Westchester Health and Wellness Information Center".to_string(),
            address: "9445 Coral Way Miami, FL".to_string(),
            zip: 33165,
            phone: "786-584-4100".to_string(),
            latitude: 26.27174,
            longitude: -80.283823,
            everything_name: "Center for Psychological Wellness".to_string(),
        },
        Location {
            name: "Mobile Library Services".to_string(),
            address: "".to_string(),
            zip: 0,
            phone: "305-480-1729".to_string(),
            latitude: 0.0,
            longitude: 0.0,
            everything_name: "Mobile Library Services".to_string(),
        },
        Location {
            name: "Westchester Regional".to_string(),
            address: "9445 Coral Way Miami, FL".to_string(),
            zip: 33165,
            phone: "305-553-1134".to_string(),
            latitude: 25.748257,
            longitude: -80.347626,
            everything_name: "Westchester Regional Library".to_string(),
        },
    ];

    let matcher = SkimMatcherV2::default();
    let best_match = people
        .iter()
        .filter_map(|choice| {
            matcher
                .fuzzy_match(&choice.name, &name)
                .map(|score| (choice, score))
        })
        .max_by_key(|&(_, score)| score)
        .map(|(choice, _)| choice);

    match best_match {
        Some(x) => x.to_owned(),
        None => {
            web_sys::console::error_2(
                &JsValue::from_str(&format!("{:?}", best_match)),
                &JsValue::from_str(&name),
            );
            Location {
                name: "ERROR".to_string(),
                address: "ERROR".to_string(),
                zip: 999999999_i32,
                phone: "ERROR".to_string(),
                latitude: 9999999999_f64,
                longitude: 9999999999_f64,
                everything_name: "ERROR".to_string(),
            }
        }
    }
}
